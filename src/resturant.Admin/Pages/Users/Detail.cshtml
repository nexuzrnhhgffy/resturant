@page "/Users/{id?}"
@model UserDetailModel
@{
    ViewData["Title"] = Model.IsNew ? "کاربر جدید" : "ویرایش کاربر";
}

<!-- PAGE-HEADER -->
<div class="page-header">
    <div class="page-leftheader">
        <h4 class="page-title">@ViewData["Title"]</h4>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Users"><i class="fe fe-chevron-right"></i> کاربران</a></li>
            <li class="breadcrumb-item active" aria-current="page">@(Model.IsNew ? "جدید" : "ویرایش")</li>
        </ol>
    </div>
</div>
<!-- PAGE-HEADER END -->

<!-- Row -->
<div class="row row-sm">
    <div class="col-lg-8">
        <form method="post" class="card">
            <div class="card-header border-bottom">
                <h3 class="card-title">مشخصات کاربر</h3>
            </div>
            <div class="card-body">
                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-danger alert-dismissible" role="alert">
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        @TempData["Error"]
                    </div>
                }

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">نام <span class="text-danger">*</span></label>
                            <input type="text" asp-for="User.FirstName" class="form-control" required>
                            <span asp-validation-for="User.FirstName" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">نام خانوادگی <span class="text-danger">*</span></label>
                            <input type="text" asp-for="User.LastName" class="form-control" required>
                            <span asp-validation-for="User.LastName" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">ایمیل <span class="text-danger">*</span></label>
                            <input type="email" asp-for="User.Email" class="form-control" required>
                            <span asp-validation-for="User.Email" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">تلفن</label>
                            <input type="tel" asp-for="User.Phone" class="form-control">
                            <span asp-validation-for="User.Phone" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">نوع مشتری</label>
                            <input type="text" asp-for="User.CustomerType" class="form-control" placeholder="Regular, VIP, etc.">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">تاریخ تولد</label>
                            <input type="date" asp-for="User.BirthDate" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">امتیاز وفاداری</label>
                            <input type="number" asp-for="User.LoyaltyPoints" class="form-control" min="0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">کل خریدها</label>
                            <input type="number" asp-for="User.TotalSpent" class="form-control" min="0" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">یادداشت</label>
                    <textarea asp-for="User.Notes" class="form-control" rows="3" maxlength="1000"></textarea>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" asp-for="User.IsActive" id="isActive" class="form-check-input">
                        <label class="form-check-label" for="isActive">
                            فعال
                        </label>
                    </div>
                </div>
            </div>

            <div class="card-footer border-top">
                <button type="submit" class="btn btn-primary">ذخیره</button>
                <a href="/Users" class="btn btn-secondary">بازگشت</a>
            </div>
        </form>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header border-bottom">
                <h3 class="card-title">اختصاص نقش‌ها</h3>
            </div>
            <div class="card-body">
                @if (Model.AvailableRoles != null && Model.AvailableRoles.Count > 0)
                {
                    <div class="roles-list">
                        @foreach (var role in Model.AvailableRoles)
                        {
                            var isChecked = Model.User.RoleIds.Contains(role.RoleId);
                            <div class="mb-2">
                                <div class="form-check">
                                    <input type="checkbox" 
                                           name="selectedRoles" 
                                           value="@role.RoleId" 
                                           id="role_@role.RoleId" 
                                           class="form-check-input"
                                           @(isChecked ? "checked" : "")>
                                    <label class="form-check-label" for="role_@role.RoleId">
                                        <strong>@role.RoleName</strong>
                                        <br>
                                        <small class="text-muted">@role.Description</small>
                                    </label>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">هیچ نقشی در دسترس نیست</p>
                }
            </div>
        </div>

        @if (!Model.IsNew && Model.User.AppUserId > 0)
        {
            <div class="card mt-3">
                <div class="card-header border-bottom">
                    <h3 class="card-title">اطلاعات کاربر</h3>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="text-muted">تعداد بازدید:</span>
                        <strong>@Model.User.VisitCount</strong>
                    </div>
                    <div class="mb-2">
                        <span class="text-muted">آخرین بازدید:</span>
                        <strong>@(Model.User.LastVisit?.ToString("yyyy/MM/dd HH:mm") ?? "---")</strong>
                    </div>
                    <div class="mb-2">
                        <span class="text-muted">تاریخ ثبت:</span>
                        <strong>@Model.User.RegistrationDate.ToString("yyyy/MM/dd")</strong>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
<!-- Row -->

@section Scripts {
    <script>
        $(document).ready(function () {
            // Handle role selection
            $('input[name="selectedRoles"]').change(function () {
                updateSelectedRoles();
            });

            function updateSelectedRoles() {
                var selectedRoles = [];
                $('input[name="selectedRoles"]:checked').each(function () {
                    selectedRoles.push($(this).val());
                });
                console.log('Selected roles:', selectedRoles);
            }
        });
    </script>
}
